# https://learn.microsoft.com/en-us/security-updates/securityadvisories/2014/2915720
$RegKey64 = "registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography"
$RegKey32 = "registry::HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Cryptography"

if($env:PROCESSOR_ARCHITECTURE -eq 'AMD64'){
    $RegKeys = @(
        $RegKey64, $RegKey32
    )
}
Else{
    $RegKeys = $RegKey64
}

function Test-RegistryValue {
    param (
        [parameter(Mandatory=$true)] [ValidateNotNullOrEmpty()]$Path,
        [parameter(Mandatory=$true)] [ValidateNotNullOrEmpty()]$Value 
    )    
    try {    
        Get-ItemProperty -Path $Path | Select-Object -ExpandProperty $Value -ErrorAction Stop | Out-Null return $true 
    }    
    catch {    
        return $false    
    }    
}

Foreach($RegKey in $RegKeys){
    if(-not $(Test-Path -Path "$RegKey\Wintrust")){
        New-Item -Path $RegKey -Name 'Wintrust' -Force -ea SilentlyContinue
        if(-not $(Test-Path "$RegKey\Wintrust\Config" -Path )){
            New-Item -Path "$RegKey\Wintrust" -Name 'Config' -Force -ea SilentlyContinue
        }
    }
    if(-not $(Test-RegistryValue -Path "$RegKey\Wintrust\Config" -Value 'EnableCertPaddingCheck')){
        New-ItemProperty -Path "$RegKey\Wintrust\Config" -Name 'EnableCertPaddingCheck' -Value 1 -PropertyType String -Force -ea SilentlyContinue
    }
    Else{
        Set-ItemProperty -Path "$RegKey\Wintrust\Config" -Name 'EnableCertPaddingCheck' -Value 1 -Force -ea SilentlyContinue
    }
}
