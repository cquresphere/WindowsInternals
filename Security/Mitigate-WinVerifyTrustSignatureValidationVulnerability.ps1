# https://learn.microsoft.com/en-us/security-updates/securityadvisories/2014/2915720
# https://p0w3rsh3ll.wordpress.com/2014/05/24/testing-ms13-098-certificate-padding-check/
$RegKey64 = "registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography"
$RegKey32 = "registry::HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Cryptography"

if($env:PROCESSOR_ARCHITECTURE -eq 'AMD64'){
    $RegKeys = @(
        $RegKey64, $RegKey32
    )
}
Else{
    $RegKeys = $RegKey64
}

Function Test-RegistryValue {
    param(
        [Alias("PSPath")]
        [Parameter(Position = 0, Mandatory = $true, ValueFromPipeline = $true, ValueFromPipelineByPropertyName = $true)]
        [String]$Path
        ,
        [Parameter(Position = 1, Mandatory = $true)]
        [String]$Name
        ,
        [Switch]$PassThru
    ) 
    process {
        if (Test-Path $Path) {
            $Key = Get-Item -LiteralPath $Path
            if ($Key.GetValue($Name, $null) -ne $null) {
                if ($PassThru) {
                    Get-ItemProperty $Path $Name
                } else {
                    $true
                }
            } else {
                $false
            }
        } else {
            $false
        }
    }
}

Foreach($RegKey in $RegKeys){
    if(-not $(Test-Path -Path "$RegKey\Wintrust")){
        Write-Host "Registry Key 'Wintrust' does not exist!" -ForegroundColor Yellow
        New-Item -Path $RegKey -Name 'Wintrust' -Force -ea SilentlyContinue ; if($?){Write-Host "Registry Key 'Wintrust' have been created!" -ForegroundColor Green}
        if(-not $(Test-Path "$RegKey\Wintrust\Config")){
            Write-Host "Registry Key 'Config' does not exist" -ForegroundColor Yellow
            New-Item -Path "$RegKey\Wintrust" -Name 'Config' -Force -ea SilentlyContinue ; if($?){Write-Host "Registry Key 'Config' have been created!" -ForegroundColor Green}
        }
    }
    if(-not $(Test-RegistryValue -Path "$RegKey\Wintrust\Config" -Name 'EnableCertPaddingCheck')){
        Write-Host "Registry Value 'EnableCertPaddingCheck' does not exist!" -ForegroundColor Yellow
        New-ItemProperty -Path "$RegKey\Wintrust\Config" -Name 'EnableCertPaddingCheck' -Value 1 -PropertyType String -Force -ea SilentlyContinue ; if($?){Write-Host "Registry Key's Property 'EnableCertPaddingCheck' have been created and it's value have been set!" -ForegroundColor Green}
    }
    Else{
        Set-ItemProperty -Path "$RegKey\Wintrust\Config" -Name 'EnableCertPaddingCheck' -Value 1 -Force -ea SilentlyContinue ; if($?){Write-Host "Registry Key's Property 'EnableCertPaddingCheck' value have been set!" -ForegroundColor Green}
    }
}
# Restart Cryptographic Services
Get-Service -Name CryptSvc -Verbose | Stop-Service -Verbose -Force -PassThru | Start-Service -PassThru -Verbose
