# https://learn.microsoft.com/en-us/security-updates/securityadvisories/2014/2915720
$RegKey64 = "registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Cryptography"
$RegKey32 = "registry::HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Cryptography"

if($env:PROCESSOR_ARCHITECTURE -eq 'AMD64'){
    $RegKeys = @(
        $RegKey64, $RegKey32
    )
}
Else{
    $RegKeys = $RegKey64
}

function Test-RegistryValue {
    param (
        [parameter(Mandatory=$true)] [ValidateNotNullOrEmpty()]$Path,
        [parameter(Mandatory=$true)] [ValidateNotNullOrEmpty()]$Value 
    )    
    try {    
        Get-ItemProperty -Path $Path | Select-Object -ExpandProperty $Value -ErrorAction Stop | Out-Null 
        return $true 
    }    
    catch {    
        return $false    
    }    
}

Foreach($RegKey in $RegKeys){
    if(-not $(Test-Path -Path "$RegKey\Wintrust")){
        Write-Host "Registry Key 'Wintrust' does not exist!" -ForegroundColor Yellow
        New-Item -Path $RegKey -Name 'Wintrust' -Force -ea SilentlyContinue ; if($?){Write-Host "Registry Key 'Wintrust' have been created!" -ForegroundColor Green}
        if(-not $(Test-Path "$RegKey\Wintrust\Config")){
            Write-Host "Registry Key 'Config' does not exist" -ForegroundColor Yellow
            New-Item -Path "$RegKey\Wintrust" -Name 'Config' -Force -ea SilentlyContinue ; if($?){Write-Host "Registry Key 'Config' have been created!" -ForegroundColor Green}
        }
    }
    if(-not $(Test-RegistryValue -Path "$RegKey\Wintrust\Config" -Value 'EnableCertPaddingCheck')){
        Write-Host "Registry Value 'EnableCertPaddingCheck' does not exist!" -ForegroundColor Yellow
        New-ItemProperty -Path "$RegKey\Wintrust\Config" -Name 'EnableCertPaddingCheck' -Value 1 -PropertyType String -Force -ea SilentlyContinue ; if($?){Write-Host "Registry Key's Property 'EnableCertPaddingCheck' have been created and it's value have been set!" -ForegroundColor Green}
    }
    Else{
        Set-ItemProperty -Path "$RegKey\Wintrust\Config" -Name 'EnableCertPaddingCheck' -Value 1 -Force -ea SilentlyContinue ; if($?){Write-Host "Registry Key's Property 'EnableCertPaddingCheck' value have been set!" -ForegroundColor Green}
    }
}
# Restart Cryptographic Services
Get-Service -Name CryptSvc -Verbose | Stop-Service -Verbose -Force -PassThru | Start-Service -PassThru -Verbose
